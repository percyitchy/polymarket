# Проблема: Слишком мало кошельков проходит фильтрацию

## Описание проблемы

Система собирает кошельки из двух источников:
1. **polymarketanalytics.com** - до 2500 кошельков
2. **Polymarket leaderboards** (weekly/monthly) - по 20 страниц каждой вкладки

**Ожидалось:** Сотни или тысячи кошельков должны соответствовать критериям  
**Реальность:** Только 72 кошелька в базе после обработки 2625 jobs

## Текущая статистика

- **Всего jobs в очереди:** 2628
- **Completed jobs:** 2625
- **Failed jobs:** 3
- **Уникальных адресов:** 2628
- **Кошельков в базе wallets:** 72
- **Отслеживаемых:** 68-72

## Критерии фильтрации (текущие)

### В `wallet_analyzer.py` метод `_analyze_wallet()`:

1. **Fast filter (строка 235-242):**
   - Если `traded_total < 6` → сразу отбрасывается

2. **Inactive filter (строка 256-264):**
   - Если `last_trade_at` > 3 месяцев назад → отбрасывается

3. **Main criteria (строка 271-274, 282):**
   - `traded_total >= 6` **AND** `win_rate >= 0.75` (75%)
   - Только если оба условия выполнены → сохраняется в базу

### В `db.py` метод `get_tracked_wallets()`:

- `traded_total`: 6-1200 (по умолчанию min=20, но используется 6)
- `win_rate`: >= 0.75 (75%)
- `daily_trading_frequency`: <= 20.0
- `last_trade_at`: не старше 90 дней

## Файлы для анализа

### Основные файлы:

1. **`wallet_analyzer.py`** - логика анализа и фильтрации кошельков
   - Метод `_analyze_wallet()` (строки 199-302)
   - Метод `_get_total_traded()` - получение количества trades
   - Метод `_get_closed_positions()` - получение закрытых позиций
   - Метод `_compute_win_rate_and_pnl()` - расчёт win rate
   - Метод `_get_last_trade_timestamp()` - получение последней сделки

2. **`db.py`** - работа с базой данных
   - Метод `get_tracked_wallets()` (строки 229-254)
   - Метод `upsert_wallet()` - сохранение кошелька
   - Метод `cleanup_old_wallets()` (строки 295-324)

3. **`polymarket_notifier.py`** - основной бот
   - Метод `analyze_and_filter_wallets()` (строки 461-478)
   - Метод `collect_wallets_from_polymarket_analytics()` (строки 371-400)
   - Метод `collect_wallets_from_leaderboards()` (строки 402-458)

4. **`daily_wallet_analysis.py`** - ежедневный сбор кошельков
   - Функция `collect_from_polymarket_analytics()` (строки 35-47)
   - Функция `collect_from_leaderboards()` (строки 49-67)

## Возможные причины проблемы

### 1. Слишком строгие критерии win_rate
- **Текущее:** `win_rate >= 0.75` (75%)
- **Проблема:** Возможно, большинство кошельков имеют win rate 60-74%

### 2. Проблема с получением данных из API
- Метод `_get_total_traded()` может возвращать неправильные значения
- Метод `_get_closed_positions()` может не получать все позиции
- Метод `_compute_win_rate_and_pnl()` может неправильно считать win rate

### 3. Проблема с last_trade_at
- Фильтр по 3 месяцам может быть слишком строгим
- Метод `_get_last_trade_timestamp()` может возвращать None или старые даты

### 4. Проблема с добавлением в очередь
- Метод `add_wallets_to_queue()` может не добавлять все кошельки
- Могут быть дубликаты, которые игнорируются

### 5. Проблема с сохранением в базу
- Метод `upsert_wallet()` может не сохранять кошельки
- Могут быть ошибки при сохранении, которые не логируются

## Вопросы для анализа

1. **Почему из 2625 обработанных jobs только 72 кошелька в базе?**
   - Сколько кошельков было отклонено на каждом этапе фильтрации?
   - Какие конкретно критерии не прошли?

2. **Правильно ли работает получение данных из API?**
   - Корректно ли считается `traded_total`?
   - Корректно ли считается `win_rate`?
   - Корректно ли получается `last_trade_at`?

3. **Соответствуют ли критерии реальности?**
   - Действительно ли только 72 кошелька из 2500+ имеют win_rate >= 75%?
   - Или проблема в логике расчёта win_rate?

4. **Есть ли логирование отклонений?**
   - Логируются ли причины отклонения каждого кошелька?
   - Можно ли увидеть статистику по причинам отклонения?

## Что нужно проверить

1. **Логи анализа** - посмотреть, сколько кошельков отклоняется и почему
2. **Статистику по критериям** - сколько кошельков проходит каждый критерий
3. **API ответы** - проверить, что возвращают API методы
4. **Логику расчёта win_rate** - убедиться, что она правильная

## Запрос для ChatGPT

"Проанализируй код фильтрации кошельков в системе Polymarket. 

Проблема: Из 2500+ кошельков с polymarketanalytics.com и множества кошельков с leaderboards только 72 кошелька сохраняются в базу после обработки 2625 jobs.

Критерии фильтрации:
- traded_total >= 6
- win_rate >= 0.75 (75%)
- last_trade_at не старше 90 дней
- daily_trading_frequency <= 20.0

Файлы для анализа:
- wallet_analyzer.py (метод _analyze_wallet, строки 199-302)
- db.py (метод get_tracked_wallets, строки 229-254)
- polymarket_notifier.py (метод analyze_and_filter_wallets, строки 461-478)

Вопросы:
1. Почему так мало кошельков проходит фильтрацию?
2. Правильно ли работает логика расчёта win_rate и traded_total?
3. Не слишком ли строгие критерии (особенно win_rate >= 0.75)?
4. Есть ли баги в логике фильтрации?
5. Как можно улучшить логирование, чтобы видеть статистику отклонений?"

