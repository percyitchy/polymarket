# План снижения Unknown до 20%

## Текущее состояние
- **Unknown: 63.59%** (50,128 из 78,830 рынков)
- **Цель: 20%** (15,766 рынков)
- **Нужно классифицировать: ~34,362 рынка** (43.59 п.п.)

## Реализованные улучшения ✅

### 1. Кэширование данных
- ✅ SQLite кэш для GraphQL и web scraping
- ✅ In-memory кэш для быстрого доступа
- ✅ TTL: 1 час

### 2. Агрессивная ML классификация
- ✅ Порог снижен до **0.05** (было 0.15)
- ✅ Очень агрессивный режим: **0.03** для не-Unknown
- ✅ Добавлена категория `macro/Events` в training data

### 3. Fallback классификация
- ✅ **Даты** → `macro/Events` (если не спорт)
- ✅ **Цены** → `macro/Fed` или `crypto/BTC` (по контексту)
- ✅ **event.category** из API → маппинг в наши категории
- ✅ **Эвристики** для минимальных данных (election → politics, price → crypto/macro, game → sports)

### 4. Улучшенные источники данных
- ✅ GraphQL API как fallback
- ✅ Web scraping как последний fallback
- ✅ Комбинирование `question` + `description` для классификации

## Проблемы и решения

### Проблема 1: Исторические рынки без данных
**Причина:** Многие закрытые рынки не имеют `slug`/`question` в API

**Решение:**
- ✅ Использовать `enhanced_market_data.py` для получения данных
- ✅ Кэширование для повторного использования
- ⚠️ **Нужно:** Пересчитать все кошельки с новыми улучшениями

### Проблема 2: Недостаточно агрессивная классификация
**Причина:** Слишком высокий порог для ML и недостаточно fallback правил

**Решение:**
- ✅ Порог ML снижен до 0.05
- ✅ Добавлены эвристики для минимальных данных
- ✅ Добавлена классификация по паттернам (даты, цены)

### Проблема 3: Порядок проверок
**Причина:** Некоторые паттерны перехватываются раньше (например, "December" содержит "ember" → может быть неправильно классифицирован)

**Решение:**
- ✅ Даты проверяются перед спортом
- ✅ Цены проверяются с контекстом
- ⚠️ **Нужно:** Уточнить порядок проверок для edge cases

## Следующие шаги

### Шаг 1: Пересчёт всех кошельков ⚠️
```bash
python daily_wallet_analysis.py --recompute-all-categories
```

**Ожидаемый результат:** Unknown снизится с 63.59% до ~30-40%

### Шаг 2: Анализ оставшихся Unknown
```bash
python analyze_unknown_patterns.py
```

**Цель:** Выявить паттерны в оставшихся Unknown рынках

### Шаг 3: Дополнительные улучшения (если нужно)

#### 3.1. Расширение ключевых слов
- Анализ топ-30 ключевых слов из Unknown
- Добавление их в соответствующие категории

#### 3.2. Улучшение ML training data
- Добавление больше примеров из реальных Unknown рынков
- Балансировка классов

#### 3.3. Playwright для динамического контента
- Если web scraping не даёт результатов
- Использовать Playwright для JS-рендеринга

#### 3.4. Batch requests для API
- Оптимизация запросов к GraphQL/CLOB API
- Параллельная обработка

### Шаг 4: Проверка результатов
```bash
python check_classification_improvements.py
```

**Цель:** Unknown < 20%

## Метрики успеха

- ✅ **Unknown < 20%** в базе данных
- ✅ **Активные рынки: 0% Unknown** (уже достигнуто)
- ✅ **Кэш работает:** > 0 записей в `polymarket_market_cache.db`
- ✅ **ML классификатор активен:** порог 0.05

## Ожидаемое распределение после улучшений

| Категория | Текущий % | Ожидаемый % | Изменение |
|-----------|-----------|-------------|-----------|
| other/Unknown | 63.59% | **< 20%** | -43.59 п.п. |
| crypto/BTC | 5.63% | ~8% | +2.37 п.п. |
| sports/NFL | 5.35% | ~7% | +1.65 п.п. |
| crypto/Altcoins | 4.61% | ~6% | +1.39 п.п. |
| sports/NBA | 3.66% | ~5% | +1.34 п.п. |
| tech/Releases | 3.33% | ~4% | +0.67 п.п. |
| politics/US | 2.90% | ~4% | +1.10 п.п. |
| **macro/Events** | 0% | **~15%** | +15 п.п. |
| macro/Fed | 2.18% | ~5% | +2.82 п.п. |
| Другие | 8.75% | ~26% | +17.25 п.п. |

## Команды для выполнения

```bash
# 1. Тестирование агрессивной классификации
python test_aggressive_classification.py

# 2. Пересчёт всех кошельков (займёт время)
python daily_wallet_analysis.py --recompute-all-categories

# 3. Мониторинг прогресса
python monitor_recompute.py

# 4. Проверка результатов
python check_classification_improvements.py

# 5. Анализ оставшихся Unknown (если нужно)
python analyze_unknown_patterns.py
```

## Примечания

- Пересчёт всех кошельков может занять **несколько часов**
- Рекомендуется запускать в фоновом режиме или через `screen`/`tmux`
- После пересчёта проверить результаты и при необходимости добавить дополнительные улучшения

