<context>
# Overview

Polymarket Notifier Bot — автоматизированная система мониторинга высокопроизводительных кошельков на Polymarket для обнаружения консенсусных сигналов. Бот отслеживает когда несколько успешных трейдеров одновременно покупают одинаковый исход рынка и отправляет уведомления в Telegram.

**Проблема:** Ручной мониторинг успешных трейдеров на Polymarket требует постоянного внимания и не позволяет быстро реагировать на консенсусные сигналы.

**Решение:** Автоматизированная система, которая собирает данные о лучших трейдерах, анализирует их активность и отправляет уведомления о консенсусных сигналах в реальном времени.

**Целевая аудитория:** Трейдеры на Polymarket, которые хотят отслеживать действия успешных трейдеров и получать сигналы о консенсусных покупках.

# Core Features

## 1. Сбор и анализ кошельков
- Автоматический сбор адресов кошельков из лидербордов Polymarket
- Интеграция с polymarketanalytics.com API для получения данных о трейдерах
- Анализ торговой статистики каждого кошелька (количество сделок, win rate, PnL)
- Фильтрация кошельков по строгим критериям качества

**Важность:** Обеспечивает базу данных высококачественных кошельков для мониторинга.

## 2. Система фильтрации кошельков
- Минимум 6+ закрытых позиций
- Win Rate от 75% до 100%
- Максимум 1000 сделок (исключает ботов)
- Дневная активность ≤ 20 сделок/день
- Параллельная обработка через систему очередей (7 воркеров)

**Важность:** Гарантирует, что отслеживаются только качественные, человеческие трейдеры, а не боты.

## 3. Мониторинг сделок в реальном времени
- Циклическая проверка всех отслеживаемых кошельков каждые 7 секунд
- Получение новых сделок через Polymarket Data API
- Отслеживание как BUY, так и SELL операций
- Обновление окон консенсуса для каждого рынка

**Важность:** Обеспечивает обнаружение сигналов в реальном времени с минимальной задержкой.

## 4. Обнаружение консенсусных сигналов
- Группировка сделок по рынку, исходу и направлению
- Подсчет уникальных кошельков в 15-минутном окне
- Минимальный консенсус: 3+ кошелька
- Проверка временного окна для всех сделок

**Важность:** Определяет моменты, когда несколько успешных трейдеров согласны по рынку.

## 5. Многоуровневая система фильтрации сигналов
- Проверка статуса рынка (закрыт/разрешен)
- Фильтрация по цене (блокировка завершенных рынков)
- Дедупликация сигналов (30-минутное и 10-минутное правила)
- Проверка конфликтов (противоположные сигналы)
- Проверка расхождения цен входа для первых 3 трейдеров

**Важность:** Предотвращает спам и ложные сигналы, отправляя только релевантные уведомления.

## 6. Telegram интеграция
- Форматированные HTML сообщения с деталями сигнала
- Поддержка форумов Telegram (topic support)
- Отдельные каналы для сигналов и технических уведомлений
- Кнопки для просмотра рынков

**Важность:** Обеспечивает удобный способ получения уведомлений и быстрого доступа к рынкам.

## 7. База данных и хранение
- SQLite база данных для кошельков, сделок и истории алертов
- Система очередей для анализа кошельков
- Кэширование результатов анализа
- WAL mode для лучшей конкурентности

**Важность:** Обеспечивает надежное хранение данных и эффективную обработку.

## 8. Автоматизация и обслуживание
- Cron задачи для периодического обновления кошельков
- Systemd сервис для непрерывной работы
- Автоматический перезапуск при сбоях
- Ежедневная очистка и обновление данных

**Важность:** Обеспечивает стабильную работу системы 24/7 без ручного вмешательства.

# User Experience

## User Personas

**Основной пользователь:** Активный трейдер на Polymarket, который хочет:
- Отслеживать действия успешных трейдеров
- Получать уведомления о консенсусных сигналах
- Быстро реагировать на возможности рынка

## Key User Flows

1. **Начальная настройка:**
   - Пользователь создает Telegram бота
   - Настраивает переменные окружения
   - Запускает бота
   - Бот автоматически собирает кошельки и начинает мониторинг

2. **Получение сигнала:**
   - Бот обнаруживает консенсусный сигнал
   - Проверяет все фильтры
   - Отправляет форматированное сообщение в Telegram
   - Пользователь видит детали сигнала и может перейти к рынку

3. **Ежедневное использование:**
   - Бот работает в фоне 24/7
   - Автоматически обновляет список кошельков
   - Отправляет сигналы по мере их обнаружения
   - Пользователь получает уведомления и принимает решения

## UI/UX Considerations

- Четкий формат сообщений с ключевой информацией
- Быстрый доступ к рынкам через кнопки
- Разделение сигналов и технических уведомлений
- Логирование для отладки и мониторинга
</context>

<PRD>
# Technical Architecture

## System Components

### 1. Главный модуль мониторинга (`polymarket_notifier.py`)
- Основной цикл проверки кошельков
- Управление окнами консенсуса
- Координация всех компонентов системы

### 2. Модуль анализа кошельков (`wallet_analyzer.py`)
- Система очередей для анализа (`wallet_analysis_jobs`)
- Параллельная обработка через воркеры (7 штук)
- Фильтрация по критериям качества
- Кэширование результатов (`wallet_analysis_cache`)

### 3. Модуль базы данных (`db.py`)
- Управление таблицами: wallets, last_trades, alerts_sent, rolling_buys
- SQLite с WAL mode для конкурентности
- Операции CRUD для всех сущностей

### 4. Модуль уведомлений (`notify.py`)
- Форматирование сообщений для Telegram
- Интеграция с Telegram Bot API
- Получение информации о рынках через API
- Поддержка форумов (topic support)

### 5. Модули сбора данных
- `fetch_polymarket_analytics_api.py` - API polymarketanalytics.com
- `fetch_leaderboards.py` - Парсинг лидербордов Polymarket
- `check_polymarket_analytics.py` - Периодическая проверка

### 6. Вспомогательные модули
- `price_fetcher.py` - Получение цен рынков
- `market_utils.py` - Утилиты для работы с рынками
- `proxy_manager.py` - Управление прокси для запросов

## Data Models

### wallets
- address (PRIMARY KEY)
- display, traded_total, win_rate, realized_pnl_total
- daily_trading_frequency, source
- added_at, updated_at

### last_trades
- address (PRIMARY KEY)
- last_seen_trade_id, updated_at

### alerts_sent
- alert_key (PRIMARY KEY)
- condition_id, outcome_index, side
- wallet_count, price, wallets_csv
- sent_at

### rolling_buys
- k (PRIMARY KEY) - hash от condition_id:outcome_index:side
- data (JSON) - события и временные метки
- updated_at

### wallet_analysis_jobs
- id (PRIMARY KEY)
- address, display, source
- status (pending/processing/completed/failed)
- created_at, updated_at, next_retry_at

### wallet_analysis_cache
- address (PRIMARY KEY)
- traded_total, win_rate, realized_pnl_total, daily_trading_frequency
- analysis_result (accepted/rejected)
- updated_at

## APIs and Integrations

### Polymarket Data API
- `/traded?user={address}` - количество сделок
- `/closed-positions?user={address}` - win rate и PnL
- `/trades?user={address}&side=BUY` - новые сделки
- CLOB API - статус рынков и цены

### polymarketanalytics.com API
- `/api/traders-tag-performance` - список трейдеров
- До 2000 адресов за запрос

### Telegram Bot API
- Отправка сообщений
- Поддержка форумов (message_thread_id)
- HTML форматирование

## Infrastructure Requirements

- Python 3.11 или 3.12 (не 3.13 из-за Playwright)
- SQLite база данных
- Интернет соединение для API запросов
- Systemd для запуска как сервис (опционально)
- Cron для периодических задач (опционально)

# Development Roadmap

## Phase 1: MVP - Базовая функциональность
- Сбор кошельков из одного источника (лидерборды)
- Базовый анализ кошельков (количество сделок, win rate)
- Простая фильтрация (минимум критериев)
- Мониторинг сделок (один кошелек за раз)
- Базовое обнаружение консенсуса (3+ кошелька)
- Простые Telegram уведомления

**Цель:** Рабочий прототип, который может обнаруживать и отправлять базовые сигналы.

## Phase 2: Улучшенная фильтрация и анализ
- Множественные источники кошельков (лидерборды + polymarketanalytics.com)
- Расширенные критерии фильтрации (daily frequency, max trades)
- Система очередей для анализа
- Параллельная обработка через воркеры
- Кэширование результатов анализа

**Цель:** Качественная база данных кошельков с эффективной обработкой.

## Phase 3: Продвинутая система фильтрации сигналов
- Проверка статуса рынков (закрыт/разрешен)
- Фильтрация по ценам
- Дедупликация сигналов (30-минутное правило)
- Проверка конфликтов (противоположные сигналы)
- Проверка расхождения цен

**Цель:** Только релевантные сигналы без спама и ложных срабатываний.

## Phase 4: Автоматизация и стабильность
- Systemd сервис для непрерывной работы
- Cron задачи для периодического обновления
- Автоматический перезапуск при сбоях
- Логирование и мониторинг
- Ежедневная очистка данных

**Цель:** Стабильная работа 24/7 без ручного вмешательства.

## Phase 5: Оптимизация и улучшения
- Оптимизация производительности
- Улучшение формата уведомлений
- Дополнительные источники данных
- Расширенная аналитика
- Экспорт данных (Excel, CSV)

**Цель:** Масштабируемая и удобная система для долгосрочного использования.

# Logical Dependency Chain

## Foundation Layer (Должно быть построено первым)
1. База данных и схемы таблиц
2. Базовые модули (db.py, notify.py)
3. Простые API клиенты для Polymarket

**Причина:** Все остальные компоненты зависят от этих базовых элементов.

## Data Collection Layer
4. Модуль сбора кошельков из лидербордов
5. Модуль анализа кошельков (базовая версия)
6. Система фильтрации кошельков

**Причина:** Нужна база данных кошельков перед началом мониторинга.

## Monitoring Layer
7. Модуль мониторинга сделок
8. Система окон консенсуса (rolling_buys)
9. Базовое обнаружение консенсуса

**Причина:** Мониторинг требует наличия кошельков в базе данных.

## Alert Layer
10. Модуль форматирования уведомлений
11. Интеграция с Telegram
12. Базовая отправка сигналов

**Причина:** Обнаружение консенсуса должно приводить к уведомлениям.

## Enhancement Layer (Можно улучшать параллельно)
13. Расширенные источники данных (polymarketanalytics.com)
14. Система очередей и воркеров
15. Продвинутая фильтрация сигналов
16. Дедупликация и проверка конфликтов

**Причина:** Эти улучшения добавляются поверх рабочего MVP.

## Automation Layer (Финальный слой)
17. Systemd сервис
18. Cron задачи
19. Автоматическая очистка и обслуживание

**Причина:** Автоматизация требует стабильной работы всех предыдущих слоев.

# Risks and Mitigations

## Technical Challenges

**Риск:** Изменения в Polymarket API могут сломать функциональность
**Митигация:** 
- Использование официальных API endpoints где возможно
- Обработка ошибок и retry логика
- Мониторинг ошибок API и быстрое реагирование

**Риск:** Высокая нагрузка на API при мониторинге большого количества кошельков
**Митигация:**
- Оптимизация интервалов проверки
- Кэширование результатов
- Использование очередей для контроля нагрузки

**Риск:** Ложные сигналы из-за несовершенной фильтрации
**Митигация:**
- Многоуровневая система фильтрации
- Постоянное тестирование и улучшение критериев
- Логирование всех блокировок для анализа

## MVP Scope

**Риск:** Переоценка объема MVP
**Митигация:**
- Начать с минимальной функциональности (один источник, базовые фильтры)
- Постепенно добавлять функции
- Фокус на работоспособности, а не полноте функций

**Риск:** Сложность интеграции множественных компонентов
**Митигация:**
- Модульная архитектура
- Тестирование каждого компонента отдельно
- Постепенная интеграция компонентов

## Resource Constraints

**Риск:** Ограничения бесплатных API
**Митигация:**
- Оптимизация количества запросов
- Кэширование где возможно
- Мониторинг использования API

**Риск:** Производительность при масштабировании
**Митигация:**
- Использование параллельной обработки
- Оптимизация запросов к базе данных
- Мониторинг производительности

# Appendix

## Research Findings

- Polymarket Data API предоставляет все необходимые данные
- Telegram Bot API надежен для уведомлений
- SQLite достаточен для текущего масштаба проекта
- Playwright необходим для парсинга React SPA лидербордов

## Technical Specifications

- Python 3.11/3.12 (не 3.13)
- SQLite с WAL mode
- Telegram Bot API
- Polymarket Data API и CLOB API
- Systemd для сервисов (Linux)
- Cron для периодических задач

## Current Statistics

- 1463 отслеживаемых кошелька
- Средний Win Rate: 97.9%
- Средняя daily frequency: 14.84 сделок/день
- Система работает стабильно 24/7
</PRD>


