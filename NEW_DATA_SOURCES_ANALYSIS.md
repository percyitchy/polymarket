# üîç –ê–Ω–∞–ª–∏–∑ –Ω–æ–≤—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Polymarket

## üìä –û–±–∑–æ—Ä –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

### 1. **CryptoHouse (ClickHouse Database)**
**URL**: https://crypto.clickhouse.com/

**–ß—Ç–æ —ç—Ç–æ:**
- –ü—É–±–ª–∏—á–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ClickHouse —Å –¥–∞–Ω–Ω—ã–º–∏ Polymarket
- –î–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ SQL –∑–∞–ø—Ä–æ—Å—ã
- –°–æ–¥–µ—Ä–∂–∏—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ —Ä—ã–Ω–∫–∞—Ö

**–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (–∏–∑ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞):**
1. `assets` - –∞–∫—Ç–∏–≤—ã/—Ç–æ–∫–µ–Ω—ã
2. `assets_mv` - –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–æ–≤
3. `block_times` - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –±–ª–æ–∫–æ–≤
4. `global_open_interest` - –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ—Ç–∫—Ä—ã—Ç—ã–π –∏–Ω—Ç–µ—Ä–µ—Å
5. `market_open_interest` - –æ—Ç–∫—Ä—ã—Ç—ã–π –∏–Ω—Ç–µ—Ä–µ—Å –ø–æ —Ä—ã–Ω–∫–∞–º
6. `orders_filled` - –∏—Å–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞
7. `orders_filled_old` - –∞—Ä—Ö–∏–≤ –∏—Å–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
8. `orders_matched` - —Å–æ–≤–ø–∞–≤—à–∏–µ –æ—Ä–¥–µ—Ä–∞
9. `orders_matched_old` - –∞—Ä—Ö–∏–≤ —Å–æ–≤–ø–∞–≤—à–∏—Ö –æ—Ä–¥–µ—Ä–æ–≤
10. `slugs` - —Å–ª–∞–≥–∏ —Ä—ã–Ω–∫–æ–≤
11. `token_id_condition` - —Å–≤—è–∑—å —Ç–æ–∫–µ–Ω–æ–≤ –∏ —É—Å–ª–æ–≤–∏–π
12. `user_balances` - –±–∞–ª–∞–Ω—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
13. `user_positions` - –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç API –∫–ª—é—á–µ–π)
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã (ClickHouse –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (open interest, balances, positions)
- ‚úÖ –î–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –∏ –∏—Ö –ø–æ–∑–∏—Ü–∏—è—Ö

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ö†Ô∏è –ú–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å)
- ‚ö†Ô∏è Rate limiting (–Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç—ã)
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –∑–Ω–∞–Ω–∏—è SQL
- ‚ö†Ô∏è –ú–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–º (–ø—É–±–ª–∏—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å)

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
1. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–µ–Ω** - –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `orders_filled` –∏–ª–∏ `orders_matched`
2. **–û—Ç–∫—Ä—ã—Ç—ã–π –∏–Ω—Ç–µ—Ä–µ—Å** - –∏–∑ `market_open_interest` –∏–ª–∏ `global_open_interest`
3. **–ü–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** - –∏–∑ `user_positions` –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫—Ä—É–ø–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
4. **–ë–∞–ª–∞–Ω—Å—ã** - –∏–∑ `user_balances` –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∫–æ—à–µ–ª—å–∫–æ–≤
5. **–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ** - –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤

---

### 2. **Goldsky Subgraphs**
**URL**: 
- https://docs.goldsky.com/subgraphs/introduction
- https://docs.goldsky.com/introduction

**–ß—Ç–æ —ç—Ç–æ:**
- –°–µ—Ä–≤–∏—Å –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –±–ª–æ–∫—á–µ–π–Ω–∞ —á–µ—Ä–µ–∑ subgraphs
- –ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å The Graph Protocol
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ The Graph —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è on-chain –¥–∞–Ω–Ω—ã—Ö Polymarket
- ‚úÖ GraphQL API –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ Webhooks –¥–ª—è real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö EVM —Ü–µ–ø–µ–π
- ‚úÖ –î–æ 6x –±—ã—Å—Ç—Ä–µ–µ —á–µ–º The Graph
- ‚úÖ 99.9%+ uptime

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ Real-time –¥–∞–Ω–Ω—ã–µ (–º–µ–Ω—å—à–µ –∑–∞–¥–µ—Ä–∂–∫–∞ —á–µ–º —É –ø—É–±–ª–∏—á–Ω—ã—Ö API)
- ‚úÖ GraphQL –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (—É–¥–æ–±–Ω–æ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤)
- ‚úÖ Webhooks (push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ polling)
- ‚úÖ –í—ã—Å–æ–∫–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å The Graph

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ subgraph (–µ—Å–ª–∏ –Ω–µ—Ç –≥–æ—Ç–æ–≤–æ–≥–æ)
- ‚ö†Ô∏è –ú–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å API –∫–ª—é—á (–Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å)
- ‚ö†Ô∏è –ù—É–∂–Ω–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –º–∏–≥—Ä–∞—Ü–∏–µ–π –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ–º subgraph

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
1. **Real-time —Å–æ–±—ã—Ç–∏—è** - —á–µ—Ä–µ–∑ webhooks –ø–æ–ª—É—á–∞—Ç—å –Ω–æ–≤—ã–µ —Å–¥–µ–ª–∫–∏
2. **GraphQL –∑–∞–ø—Ä–æ—Å—ã** - –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ —Ä—ã–Ω–∫–∞—Ö –∏ —Å–¥–µ–ª–∫–∞—Ö
3. **–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ** - —á–µ—Ä–µ–∑ GraphQL –∑–∞–ø—Ä–æ—Å—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
4. **–ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** - —á–µ—Ä–µ–∑ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

---

## üéØ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–∏—Å—Ç–µ–º—É

### –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö

**–î–ª—è —Ü–µ–Ω:**
1. Polymarket CLOB API `/price` (primary)
2. Gamma API (fallback #1)
3. –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫ (fallback #2)
4. HashiDive API (fallback #3)
5. ClickHouse database (fallback #4) ‚Üê NEW
6. FinFeed API (fallback #5)
7. –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∏–∑ wallet_prices (fallback #6)

**–î–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Ä—ã–Ω–∫–æ–≤:**
1. Closed positions API
2. Gamma API
3. CLOB API
4. Data API
5. GraphQL API (enhanced_market_data.py)
6. Web Scraping (enhanced_market_data.py)

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

#### **CryptoHouse (ClickHouse)**

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π (fallback –¥–ª—è —Ü–µ–Ω –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö)

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `price_fetcher.py`:**
‚úÖ **Completed**: Implemented `get_price_from_clickhouse()` function using `ClickHouseClient` class.

```python
from clickhouse_client import ClickHouseClient, RateLimitExceeded

def get_price_from_clickhouse(token_id: str) -> Optional[float]:
    """
    Get price from ClickHouse database
    
    Uses ClickHouseClient class with:
    - Rate limiting (60 queries/hour)
    - Retry logic with exponential backoff
    - Error handling for timeouts and connection errors
    - SQL injection prevention
    """
    client = ClickHouseClient()
    return client.get_latest_price(token_id)
```

**Rate limit**: 60 queries/hour (1 query per minute) - tracked in-memory with deque

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `slugs` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª–∞–≥–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `token_id_condition` –¥–ª—è —Å–≤—è–∑–∏ —Ç–æ–∫–µ–Ω–æ–≤ –∏ —É—Å–ª–æ–≤–∏–π

**–ü–æ—Ä—è–¥–æ–∫ –≤ fallback chain:**
- ‚úÖ Integrated into `price_fetcher.py` as fallback #4 (after HashDive, before FinFeed)
- Fallback order:
  1. Polymarket CLOB API `/price` (primary)
  2. Gamma API (fallback #1)
  3. Trades history average (fallback #2)
  4. HashDive API (fallback #3)
  5. **ClickHouse** (fallback #4) ‚Üê NEW
  6. FinFeed API (fallback #5)
  7. Wallet prices average (fallback #6)

---

#### **Goldsky Subgraphs**

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π (–¥–ª—è real-time —Å–æ–±—ã—Ç–∏–π –∏ GraphQL –∑–∞–ø—Ä–æ—Å–æ–≤)

**–í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–æ–≥–æ Polymarket subgraph**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ –≥–æ—Ç–æ–≤—ã–π Polymarket subgraph –Ω–∞ Goldsky
- –ï—Å–ª–∏ –µ—Å—Ç—å - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ GraphQL endpoint
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `enhanced_market_data.py` –∫–∞–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É GraphQL

**–í–∞—Ä–∏–∞–Ω—Ç 2: –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ subgraph**
- –°–æ–∑–¥–∞—Ç—å subgraph –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π Polymarket
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhooks –¥–ª—è real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–æ–≤—ã—Ö —Å–¥–µ–ª–∫–∞—Ö
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –∫—Ä—É–ø–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏—è—Ö

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `enhanced_market_data.py`:**
```python
GOLDSKY_GRAPHQL_ENDPOINT = "https://api.goldsky.com/api/public/project/<project-id>/subgraph/<subgraph-name>/<version>/graphql"

def get_market_data_from_goldsky(condition_id: str) -> Optional[Dict[str, Any]]:
    """
    Get market data from Goldsky subgraph GraphQL API
    """
    try:
        query = """
        query GetMarket($conditionId: String!) {
            market(id: $conditionId) {
                id
                slug
                question
                endDate
                active
                ...
            }
        }
        """
        
        variables = {"conditionId": condition_id}
        
        response = requests.post(
            GOLDSKY_GRAPHQL_ENDPOINT,
            json={"query": query, "variables": variables},
            headers={"Content-Type": "application/json"},
            timeout=10
        )
        
        if response.status_code == 200:
            data = response.json()
            return parse_goldsky_response(data)
            
    except Exception as e:
        logger.debug(f"[Goldsky] Error getting market data: {e}")
        return None
```

**Webhooks –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
- –°–æ–∑–¥–∞—Ç—å endpoint –¥–ª—è –ø—Ä–∏–µ–º–∞ webhooks –æ—Ç Goldsky
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–æ–≤—ã—Ö –∫—Ä—É–ø–Ω—ã—Ö —Å–¥–µ–ª–∫–∞—Ö
- –ú–æ–∂–µ—Ç –∑–∞–º–µ–Ω–∏—Ç—å –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç—å polling –º–µ—Ö–∞–Ω–∏–∑–º

---

## üìã –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### –§–∞–∑–∞ 1: –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. **CryptoHouse:**
   - [x] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏ —Ñ–æ—Ä–º–∞—Ç API
   - [x] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å SQL –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
   - [x] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö (–∑–∞–¥–µ—Ä–∂–∫–∞)
   - [x] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å rate limits
   - [x] –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω
   - ‚úÖ **Completed**: ClickHouse client implemented in `clickhouse_client.py`

2. **Goldsky:**
   - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ –≥–æ—Ç–æ–≤—ã–π Polymarket subgraph
   - [ ] –ò–∑—É—á–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å The Graph
   - [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å GraphQL –∑–∞–ø—Ä–æ—Å—ã
   - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ API –∫–ª—é—á–∞–º
   - [ ] –ò–∑—É—á–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ webhooks

### –§–∞–∑–∞ 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

1. **CryptoHouse:**
   - [x] –°–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª—å `clickhouse_client.py`
   - [x] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `price_fetcher.py` –∫–∞–∫ fallback
   - [x] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
   - [ ] –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –±—É–¥—É—â–µ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
   - ‚úÖ **Completed**: ClickHouse integrated into `price_fetcher.py` as fallback #4 (after HashDive, before FinFeed)
   - ‚úÖ **Rate limit**: 60 queries/hour (1 query per minute) - implemented with in-memory tracking

2. **Goldsky:**
   - [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å subgraph (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π)
   - [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å GraphQL –≤ `enhanced_market_data.py`
   - [ ] –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å webhooks –¥–ª—è real-time —Å–æ–±—ã—Ç–∏–π
   - [ ] –î–æ–±–∞–≤–∏—Ç—å fallback –≤ —Ü–µ–ø–æ—á–∫—É –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

### –§–∞–∑–∞ 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–æ–≤—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ (batch, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ)
3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ retry –ª–æ–≥–∏–∫–∞
4. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç—ã

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### ClickHouse HTTP Interface

ClickHouse –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç HTTP –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è SQL –∑–∞–ø—Ä–æ—Å–æ–≤:

```bash
# –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ curl
curl "https://crypto.clickhouse.com/?query=SELECT%20*%20FROM%20orders_filled%20LIMIT%2010"
```

**–§–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞:**
- GET –∏–ª–∏ POST –∑–∞–ø—Ä–æ—Å
- SQL –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–µ `query` –∏–ª–∏ –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞
- –†–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON, CSV –∏–ª–∏ –¥—Ä—É–≥–∏—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö

**–ü—Ä–∏–º–µ—Ä—ã –ø–æ–ª–µ–∑–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:**

```sql
-- –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Ü–µ–Ω—É –¥–ª—è —Ç–æ–∫–µ–Ω–∞
SELECT price, timestamp
FROM orders_filled
WHERE token_id = '0x123...:0'
ORDER BY timestamp DESC
LIMIT 1

-- –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–π –∏–Ω—Ç–µ—Ä–µ—Å –¥–ª—è —Ä—ã–Ω–∫–∞
SELECT SUM(amount) as open_interest
FROM market_open_interest
WHERE condition_id = '0x123...'

-- –ü–æ–ª—É—á–∏—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT condition_id, outcome_index, amount
FROM user_positions
WHERE user_address = '0xabc...'
```

### Goldsky Subgraph

**–ú–∏–≥—Ä–∞—Ü–∏—è —Å The Graph:**
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ CLI
curl https://goldsky.com | sh

# –õ–æ–≥–∏–Ω
goldsky login

# –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ subgraph
goldsky subgraph deploy <name>/<version> --from-url <thegraph-query-url>
```

**–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ subgraph:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—Ç –∂–µ —Ñ–æ—Ä–º–∞—Ç —á—Ç–æ –∏ The Graph
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ TypeScript –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π
- GraphQL schema –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### CryptoHouse:
- ‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ —Ü–µ–Ω (fallback)
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- ‚úÖ –î–∞–Ω–Ω—ã–µ –æ –ø–æ–∑–∏—Ü–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –û—Ç–∫—Ä—ã—Ç—ã–π –∏–Ω—Ç–µ—Ä–µ—Å –ø–æ —Ä—ã–Ω–∫–∞–º

### Goldsky:
- ‚úÖ Real-time –¥–∞–Ω–Ω—ã–µ (–º–µ–Ω—å—à–µ –∑–∞–¥–µ—Ä–∂–∫–∞)
- ‚úÖ Webhooks (push –≤–º–µ—Å—Ç–æ polling)
- ‚úÖ –í—ã—Å–æ–∫–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å (99.9%+)
- ‚úÖ GraphQL –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (—É–¥–æ–±–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)

---

## ‚ö†Ô∏è –†–∏—Å–∫–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### CryptoHouse:
- ‚ö†Ô∏è –ü—É–±–ª–∏—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–º)
- ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã rate limits
- ‚ö†Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å)
- ‚ö†Ô∏è –ú–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è —Ñ–æ—Ä–º–∞—Ç API

### Goldsky:
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–µ—Å–ª–∏ –Ω–µ—Ç –≥–æ—Ç–æ–≤–æ–≥–æ subgraph)
- ‚ö†Ô∏è –ú–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å –ø–ª–∞—Ç–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É
- ‚ö†Ô∏è –ù—É–∂–Ω–æ –≤—Ä–µ–º—è –Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—é/–Ω–∞—Å—Ç—Ä–æ–π–∫—É
- ‚ö†Ô∏è –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ CryptoHouse:

```python
# test_clickhouse.py
import requests

def test_clickhouse():
    url = "https://crypto.clickhouse.com/"
    
    # –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å
    query = "SELECT COUNT(*) FROM orders_filled"
    
    response = requests.get(url, params={"query": query})
    print(response.text)

if __name__ == "__main__":
    test_clickhouse()
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Goldsky:

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ Goldsky
2. –°–æ–∑–¥–∞—Ç—å API –∫–ª—é—á
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ –≥–æ—Ç–æ–≤—ã–π Polymarket subgraph
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å GraphQL –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ –∏—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### ClickHouse (‚úÖ Completed)

1. ‚úÖ **Completed**: ClickHouse client implemented in `clickhouse_client.py`
2. ‚úÖ **Completed**: Integrated into `price_fetcher.py` as fallback #4
3. ‚úÖ **Completed**: Rate limiting implemented (60 queries/hour)
4. ‚úÖ **Completed**: Error handling and retry logic implemented
5. ‚úÖ **Completed**: Test script updated to use new client

**Future Enhancements:**
- [ ] Add caching for frequently accessed data
- [ ] Monitor ClickHouse query performance
- [ ] Integrate other ClickHouse tables (open interest, positions, balances) into main workflow
- [ ] Add batch query support for multiple token_ids
- [ ] Optimize queries for better performance

### Goldsky (Pending)

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:**
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Goldsky —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ –≥–æ—Ç–æ–≤—ã–π Polymarket subgraph
   - –ò–∑—É—á–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é Goldsky

2. **–ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ (1-2 –¥–Ω—è):**
   - –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è Goldsky
   - –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç API –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
   - –û—Ü–µ–Ω–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å

3. **–°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω–æ (–Ω–µ–¥–µ–ª—è):**
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Goldsky subgraph –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π
   - –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å GraphQL –≤ `enhanced_market_data.py`
   - –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

4. **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ:**
   - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhooks (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)
   - –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

---

## üîß ClickHouse Client Usage

### ClickHouseClient Class

The `ClickHouseClient` class provides a clean interface to the ClickHouse database at `crypto.clickhouse.com`.

**Initialization:**
```python
from clickhouse_client import ClickHouseClient

client = ClickHouseClient(
    base_url="https://crypto.clickhouse.com/",
    database="polymarket",
    timeout=10
)
```

**Available Methods:**

1. **`test_connection() -> bool`**
   - Tests connection to ClickHouse database
   - Returns True if successful, False otherwise
   - Example: `client.test_connection()`

2. **`get_latest_price(token_id: str) -> Optional[float]`**
   - Gets latest price for a token from `orders_filled` table
   - Returns price as float or None if no data found
   - Example: `price = client.get_latest_price("0x123...:0")`

3. **`get_market_open_interest(condition_id: str) -> Optional[Dict[str, Any]]`**
   - Gets market open interest for a condition
   - Returns dict with open interest data or None
   - Example: `oi = client.get_market_open_interest("0x123...")`

4. **`get_user_positions(user_address: str, condition_id: Optional[str] = None) -> List[Dict[str, Any]]`**
   - Gets user positions from `user_positions` table
   - Returns list of positions or empty list
   - Example: `positions = client.get_user_positions("0xabc...")`

5. **`get_user_balances(user_address: str) -> Optional[Dict[str, Any]]`**
   - Gets user balances from `user_balances` table
   - Returns dict with balance data or None
   - Example: `balances = client.get_user_balances("0xabc...")`

6. **`get_recent_trades(token_id: str, limit: int = 10) -> List[Dict[str, Any]]`**
   - Gets recent trades for a token
   - Returns list of trades or empty list
   - Example: `trades = client.get_recent_trades("0x123...:0", limit=5)`

7. **`get_rate_limit_status() -> Dict[str, Any]`**
   - Gets current rate limit status
   - Returns dict with queries_used, queries_remaining, reset_time
   - Example: `status = client.get_rate_limit_status()`

**Error Handling:**

- `ClickHouseError`: Base exception for ClickHouse errors
- `RateLimitExceeded`: Raised when rate limit is exceeded (includes wait_time)
- All methods return None/empty list on error (never raise exceptions to caller)

**Rate Limiting:**

- Rate limit: 60 queries per hour (1 query per minute)
- Tracked in-memory using `collections.deque` with maxlen=60
- Automatically removes timestamps older than 1 hour
- Raises `RateLimitExceeded` exception when limit exceeded
- `get_rate_limit_status()` provides current status

**SQL Injection Prevention:**

- Input sanitization: Escapes single quotes in user input
- Input validation: Validates token_id and condition_id formats
- Parameterized queries: Uses proper SQL escaping

**Response Format Handling:**

- Supports JSONEachRow (one JSON object per line) - most common
- Supports JSON (single JSON object with data array)
- Supports TabSeparated (tab-separated values) - fallback
- Handles empty responses gracefully

**Retry Logic:**

- Uses `tenacity` library for retry logic
- 3 attempts with exponential backoff
- Retries on timeout and connection errors
- Logs all retry attempts

**Logging:**

- Uses Python `logging` module
- Logs queries at DEBUG level
- Logs errors at WARNING level
- Logs rate limit status at INFO level
- Logs connection tests at INFO level

**Example Usage:**

```python
from clickhouse_client import ClickHouseClient, RateLimitExceeded

client = ClickHouseClient()

# Test connection
if client.test_connection():
    print("‚úÖ Connected to ClickHouse")

# Check rate limit
status = client.get_rate_limit_status()
print(f"Queries remaining: {status['queries_remaining']}")

# Get latest price
try:
    price = client.get_latest_price("0x123...:0")
    if price:
        print(f"Latest price: {price}")
except RateLimitExceeded as e:
    print(f"Rate limit exceeded, wait {e.wait_time:.1f}s")
```

**Troubleshooting:**

1. **Connection errors**: Check if `crypto.clickhouse.com` is accessible
2. **Rate limit errors**: Wait for rate limit window to reset (1 hour)
3. **Empty results**: Verify token_id/condition_id format and data availability
4. **Timeout errors**: Increase timeout parameter (default: 10s)
5. **SQL errors**: Check query syntax and table names

---

## üìä Rate Limiting Details

### How Rate Limiting Works

- **Limit**: 60 queries per hour (1 query per minute)
- **Tracking**: In-memory `deque` with maxlen=60 stores query timestamps
- **Window**: 1 hour (3600 seconds)
- **Behavior**: Before each query, removes timestamps older than 1 hour, then checks if limit exceeded

### What Happens When Rate Limit is Exceeded

- Raises `RateLimitExceeded` exception with `wait_time` (seconds until oldest query expires)
- Logs warning message with queries used and wait time
- In `price_fetcher.py`, rate limit errors are caught and logged, then continues to next fallback

### Managing Rate Limits

- **Monitor usage**: Use `get_rate_limit_status()` to check current usage
- **Batch queries**: Group multiple queries together when possible
- **Cache results**: Cache frequently accessed data to reduce queries
- **Respect limits**: Don't make rapid successive queries

### Rate Limit Status Example

```python
status = client.get_rate_limit_status()
# Returns:
# {
#     'queries_used': 45,
#     'queries_remaining': 15,
#     'queries_per_hour': 60,
#     'reset_time': '2025-01-15T10:00:00',
#     'reset_timestamp': 1705312800.0
# }
```

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- **CryptoHouse**: https://crypto.clickhouse.com/
- **Goldsky Docs**: https://docs.goldsky.com/
- **Goldsky Subgraphs**: https://docs.goldsky.com/subgraphs/introduction
- **ClickHouse Docs**: https://clickhouse.com/docs/en/

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: 2025-01-XX*
*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2025-01-15*
*ClickHouse integration completed: 2025-01-15*

